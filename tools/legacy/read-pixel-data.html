<!DOCTYPE html>
<html>
	<head>
		<title>Read canvas pixel data</title>
		<meta charset="utf-8" />
		<style type="text/css"></style>
	</head>
	<body>
		<canvas id="canvas"></canvas>

		<script type="text/javascript">
			var canvas = document.getElementById('canvas');
			var canvas_ctx = canvas.getContext('2d');

			var images_base_path = '../data/png/';

			var images = [
				{ src: 'webcolors-rgb.png', id: 'rgb' },
				{ src: 'webcolors-cmyk-fogra-coated.png', id: 'fogra-coated' },
				{
					src: 'webcolors-cmyk-fogra-uncoated.png',
					id: 'fogra-uncoated'
				},
				{ src: 'webcolors-cmyk-web-coated.png', id: 'web-coated' },
				{ src: 'webcolors-cmyk-web-uncoated.png', id: 'web-uncoated' }
			];

			var colors = {};

			const NUMBER_OF_COLORS = 140;

			function process_image(idx) {
				if (idx >= images.length) {
					done();
					return;
				}

				var img = images[idx];

				fetch(images_base_path + img.src)
					.then(res => res.blob())
					.then(blob =>
						window.createImageBitmap(blob, {
							colorSpaceConversion: 'none'
						})
					)
					.then(bitmap => {
						colors[img.id] = extract_colors(bitmap).slice(
							0,
							NUMBER_OF_COLORS
						);
						process_image(idx + 1);
					});
			}

			const COLS = 9,
				ROWS = 16;

			function extract_colors(bitmap) {
				var ret = [];

				canvas.width = bitmap.width;
				canvas.height = bitmap.height;
				canvas_ctx.drawImage(bitmap, 0, 0);

				const cell_width = bitmap.width / COLS;
				const cell_height = bitmap.height / ROWS;

				for (var j = 0; j < ROWS; j++) {
					for (var i = 0; i < COLS; i++) {
						let left = Math.round(cell_width * i + cell_width / 2);
						let top = Math.round(cell_height * j + cell_height / 2);
						let cell_data = canvas_ctx.getImageData(
							left,
							top,
							1,
							1
						);
						let color_hex = [
							cell_data.data[0],
							cell_data.data[1],
							cell_data.data[2]
						]
							.map(component =>
								component.toString(16).padStart(2, '0')
							)
							.join('');

						ret.push(`#${color_hex}`);
					}
				}
				return ret;
			}

			function done() {
				document.write(JSON.stringify(colors, null, 2));
			}

			process_image(0);
		</script>
	</body>
</html>
